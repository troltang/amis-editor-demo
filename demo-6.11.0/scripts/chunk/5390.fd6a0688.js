"use strict";(self.webpackChunkamis_editor_demo=self.webpackChunkamis_editor_demo||[]).push([[5390],{46894:function(t,e){function a(t){return"object"!=typeof t||"toString"in t?t:Object.prototype.toString.call(t).slice(8,-1)}Object.defineProperty(e,"__esModule",{value:!0});var n="object"==typeof process&&!0;function r(t,e){if(!t){if(n)throw new Error("Invariant failed");throw new Error(e())}}e.invariant=r;var o=Object.prototype.hasOwnProperty,i=Array.prototype.splice,s=Object.prototype.toString;function u(t){return s.call(t).slice(8,-1)}var c=Object.assign||function(t,e){return l(e).forEach((function(a){o.call(e,a)&&(t[a]=e[a])})),t},l="function"==typeof Object.getOwnPropertySymbols?function(t){return Object.keys(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.keys(t)};function p(t){return Array.isArray(t)?c(t.constructor(t.length),t):"Map"===u(t)?new Map(t):"Set"===u(t)?new Set(t):t&&"object"==typeof t?c(Object.create(Object.getPrototypeOf(t)),t):t}var d=function(){function t(){this.commands=c({},f),this.update=this.update.bind(this),this.update.extend=this.extend=this.extend.bind(this),this.update.isEquals=function(t,e){return t===e},this.update.newContext=function(){return(new t).update}}return Object.defineProperty(t.prototype,"isEquals",{get:function(){return this.update.isEquals},set:function(t){this.update.isEquals=t},enumerable:!0,configurable:!0}),t.prototype.extend=function(t,e){this.commands[t]=e},t.prototype.update=function(t,e){var a=this,n="function"==typeof e?{$apply:e}:e;Array.isArray(t)&&Array.isArray(n)||r(!Array.isArray(n),(function(){return"update(): You provided an invalid spec to update(). The spec may not contain an array except as the value of $set, $push, $unshift, $splice or any custom command allowing an array value."})),r("object"==typeof n&&null!==n,(function(){return"update(): You provided an invalid spec to update(). The spec and every included key path must be plain objects containing one of the following commands: "+Object.keys(a.commands).join(", ")+"."}));var i=t;return l(n).forEach((function(e){if(o.call(a.commands,e)){var r=t===i;i=a.commands[e](n[e],i,n,t),r&&a.isEquals(i,t)&&(i=t)}else{var s="Map"===u(t)?a.update(t.get(e),n[e]):a.update(t[e],n[e]),c="Map"===u(i)?i.get(e):i[e];a.isEquals(s,c)&&(void 0!==s||o.call(t,e))||(i===t&&(i=p(t)),"Map"===u(i)?i.set(e,s):i[e]=s)}})),i},t}();e.Context=d;var f={$push:function(t,e,a){return h(e,a,"$push"),t.length?e.concat(t):e},$unshift:function(t,e,a){return h(e,a,"$unshift"),t.length?t.concat(e):e},$splice:function(t,e,n,o){return function(t,e){r(Array.isArray(t),(function(){return"Expected $splice target to be an array; got "+a(t)})),b(e.$splice)}(e,n),t.forEach((function(t){b(t),e===o&&t.length&&(e=p(o)),i.apply(e,t)})),e},$set:function(t,e,a){return function(t){r(1===Object.keys(t).length,(function(){return"Cannot have more than one key in an object with $set"}))}(a),t},$toggle:function(t,e){y(t,"$toggle");var a=t.length?p(e):e;return t.forEach((function(t){a[t]=!e[t]})),a},$unset:function(t,e,a,n){return y(t,"$unset"),t.forEach((function(t){Object.hasOwnProperty.call(e,t)&&(e===n&&(e=p(n)),delete e[t])})),e},$add:function(t,e,a,n){return g(e,"$add"),y(t,"$add"),"Map"===u(e)?t.forEach((function(t){var a=t[0],r=t[1];e===n&&e.get(a)!==r&&(e=p(n)),e.set(a,r)})):t.forEach((function(t){e!==n||e.has(t)||(e=p(n)),e.add(t)})),e},$remove:function(t,e,a,n){return g(e,"$remove"),y(t,"$remove"),t.forEach((function(t){e===n&&e.has(t)&&(e=p(n)),e.delete(t)})),e},$merge:function(t,e,n,o){var i,s;return i=e,r((s=t)&&"object"==typeof s,(function(){return"update(): $merge expects a spec of type 'object'; got "+a(s)})),r(i&&"object"==typeof i,(function(){return"update(): $merge expects a target of type 'object'; got "+a(i)})),l(t).forEach((function(a){t[a]!==e[a]&&(e===o&&(e=p(o)),e[a]=t[a])})),e},$apply:function(t,e){var n;return r("function"==typeof(n=t),(function(){return"update(): expected spec of $apply to be a function; got "+a(n)+"."})),t(e)}},m=new d;function h(t,e,n){r(Array.isArray(t),(function(){return"update(): expected target of "+a(n)+" to be an array; got "+a(t)+"."})),y(e[n],n)}function y(t,e){r(Array.isArray(t),(function(){return"update(): expected spec of "+a(e)+" to be an array; got "+a(t)+". Did you forget to wrap your parameter in an array?"}))}function b(t){r(Array.isArray(t),(function(){return"update(): expected spec of $splice to be an array of arrays; got "+a(t)+". Did you forget to wrap your parameters in an array?"}))}function g(t,e){var n=u(t);r("Map"===n||"Set"===n,(function(){return"update(): "+a(e)+" expects a target of type Set or Map; got "+a(n)}))}e.isEquals=m.update.isEquals,e.extend=m.extend,e.default=m.update,e.default.default=t.exports=c(e.default,e)},75390:function(t,e,a){a.r(e),a.d(e,{TaskRenderer:function(){return l},default:function(){return c}});var n=a(31635),r=a(96540),o=a(62758),i=a(46894),s=a.n(i),u=a(71121),c=function(t){function e(e){var a=t.call(this,e)||this;return a.state={items:e.items?e.items.concat():[]},a.handleLoaded=a.handleLoaded.bind(a),a.tick=a.tick.bind(a),a}return(0,n.C6)(e,t),e.prototype.componentDidMount=function(){this.tick(!!this.props.checkApi)},e.prototype.componentDidUpdate=function(t){var e=this.props;t.items!==e.items?this.setState({items:e.items?e.items.concat():[]}):(0,o.B92)(t.checkApi,e.checkApi,t.data,e.data)&&this.tick(!0)},e.prototype.componentWillUnmount=function(){clearTimeout(this.timer)},e.prototype.reload=function(){this.tick(!0)},e.prototype.tick=function(t){var e=this;void 0===t&&(t=!1);var a=this.props,n=a.loadingStatusCode,r=a.data,i=a.interval,s=a.checkApi,u=a.env,c=this.state.items;if(clearTimeout(this.timer),t||c.some((function(t){return t.status===n})))return i&&!(0,o.Amo)(s)?u.alert("checkApi 没有设置, 不能及时获取任务状态"):void((0,o.Amo)(s,r)&&u&&u.fetcher(s,r).then(this.handleLoaded).catch((function(t){return e.setState({error:t})})))},e.prototype.handleLoaded=function(t){if(!Array.isArray(t.data))return this.props.env.alert("返回格式不正确, 期望 response.data 为数组, 包含每个 task 的状态信息");this.setState({items:t.data});var e=this.props.interval;clearTimeout(this.timer),this.timer=setTimeout(this.tick,e)},e.prototype.submitTask=function(t,e,a){var r=this;void 0===a&&(a=!1);var i=this.props,u=i.submitApi,c=i.reSubmitApi,l=i.loadingStatusCode,p=i.errorStatusCode,d=i.data,f=i.env;if(!a&&!(0,o.Amo)(u))return f.alert("submitApi 没有配置");if(a&&!(0,o.Amo)(c))return f.alert("reSubmitApi 没有配置");this.setState(s()(this.state,{items:{$splice:[[e,1,(0,n.Cl)((0,n.Cl)({},t),{status:l})]]}}));var m=a?c:u;(0,o.Amo)(m,d)&&f&&f.fetcher(m,(0,o.ed2)(d,t)).then((function(t){if(t&&t.data)if(Array.isArray(t.data))r.handleLoaded(t);else{m&&m.replaceData;var e=r.state.items.map((function(e){return e.key===t.data.key?(0,n.Cl)((0,n.Cl)({},m.replaceData?{}:e),t.data):e}));r.handleLoaded((0,n.Cl)((0,n.Cl)({},t),{data:e}))}else clearTimeout(r.timer),r.timer=setTimeout(r.tick,4)})).catch((function(a){return r.setState(s()(r.state,{items:{$splice:[[e,1,(0,n.Cl)((0,n.Cl)({},t),{status:p,remark:a.message||a})]]}}))}))},e.prototype.render=function(){var t=this,e=this.props,a=e.classnames,n=e.className,o=e.style,i=e.tableClassName,s=e.taskNameLabel,c=e.operationLabel,l=e.statusLabel,p=e.remarkLabel,d=e.btnText,f=e.retryBtnText,m=e.btnClassName,h=e.retryBtnClassName,y=e.statusLabelMap,b=e.statusTextMap,g=e.readyStatusCode,v=e.loadingStatusCode,k=e.canRetryStatusCode,C=e.translate,E=e.render,A=e.loadingConfig,$=this.state.items,S=this.state.error;return r.createElement("div",{className:a("Table-content",n),style:o},r.createElement("table",{className:a("Table-table",i)},r.createElement("thead",null,r.createElement("tr",null,r.createElement("th",null,s),r.createElement("th",null,C(c)),r.createElement("th",null,l),r.createElement("th",null,p))),r.createElement("tbody",null,S?r.createElement("tr",null,r.createElement("td",{colSpan:4},r.createElement("div",{className:"text-danger"},S))):$.map((function(e,n){return r.createElement("tr",{key:n},r.createElement("td",null,r.createElement("span",{className:a("word-break")},e.label)),r.createElement("td",null,e.status==v?r.createElement(u.y$,{loadingConfig:A,show:!0,icon:"reload",spinnerClassName:a("Task-spinner")}):e.status==k?r.createElement("a",{onClick:function(){return t.submitTask(e,n,!0)},className:a("Button","Button--danger","Button--size-md",h||m)},f||d):r.createElement("a",{onClick:function(){return t.submitTask(e,n)},className:a("Button","Button--default","Button--size-md",m,{disabled:e.status!==g})},d)),r.createElement("td",null,r.createElement("span",{className:a("label",y&&y[e.status||0])},b&&b[e.status||0])),r.createElement("td",null,e.remark?E("".concat(n,"/remark"),e.remark):null))})))))},e.defaultProps={className:"",tableClassName:"",taskNameLabel:"任务名称",operationLabel:"Table.operation",statusLabel:"状态",remarkLabel:"备注说明",btnText:"上线",retryBtnText:"重试",btnClassName:"",retryBtnClassName:"",statusLabelMap:["label-warning","label-info","label-info","label-danger","label-success","label-danger"],statusTextMap:["未开始","就绪","进行中","出错","已完成","出错"],initialStatusCode:0,readyStatusCode:1,loadingStatusCode:2,errorStatusCode:3,finishStatusCode:4,canRetryStatusCode:5,interval:3e3},e}(r.Component),l=function(t){function e(e,a){var n=t.call(this,e)||this;return a.registerComponent(n),n}return(0,n.C6)(e,t),e.prototype.componentWillUnmount=function(){t.prototype.componentWillUnmount.call(this),this.context.unRegisterComponent(this)},e.contextType=o.MzX,(0,n.Cg)([(0,o.A49)({type:"tasks"}),(0,n.Sn)("design:paramtypes",[Object,Object])],e)}(c)}}]);