"use strict";(self.webpackChunkamis_editor_demo=self.webpackChunkamis_editor_demo||[]).push([[6506],{46506:function(e,t,r){r.r(t),r.d(t,{Log:function(){return c},LogRenderer:function(){return u}});var n=r(31635),s=r(96540),o=r(62758),i=r(71121),l={30:"black",31:"red",32:"green",33:"yellow",34:"blue",35:"magenta",36:"cyan",37:"white",90:"grey"},a={40:"black",41:"red",42:"green",43:"yellow",44:"blue",45:"magenta",46:"cyan",47:"white"},c=function(e){function t(t){var r=e.call(this,t)||this;return r.isDone=!1,r.autoScroll=!1,r.state={lastLine:"",logs:[],originLastLine:"",originLogs:[],refresh:!0,showLineNumber:!1,filterWord:""},r.refresh=function(e){var t=r.state.refresh;r.setState({refresh:!t}),t||(r.clear(e),r.loadLogs()),e.preventDefault()},r.clear=function(e){r.setState({logs:r.logs=[],lastLine:r.lastLine="",originLogs:[],originLastLine:""}),null==e||e.preventDefault()},r.filterWord=function(e,t,n){var s=e,o=t;""!==n&&null!=n&&n.length>0&&(e=e.filter((function(e){return e.includes(n)})),t.includes(n)||(t="")),r.setState({filterWord:n,lastLine:r.lastLine=t,logs:r.logs=e,originLogs:s,originLastLine:o})},r.addLines=function(e){e=e.concat();var t=r.props.maxLength,n=r.lastLine||"",s=(r.logs||[]).concat();1===e.length?(n+=e[0],r.setState({lastLine:r.lastLine=n})):(e[0]=n+(e[0]||""),n=e.pop()||"",t&&s.length+e.length>t&&s.splice(0,s.length+e.length-t),s=s.concat(e),r.filterWord(s,n,r.state.filterWord))},r.logRef=s.createRef(),r.autoScroll=t.autoScroll||!1,r.pauseOrResumeScrolling=r.pauseOrResumeScrolling.bind(r),r}return(0,n.C6)(t,e),t.prototype.componentWillUnmount=function(){this.logRef&&this.logRef.current&&this.logRef.current.removeEventListener("scroll",this.pauseOrResumeScrolling)},t.prototype.componentDidMount=function(){if(this.autoScroll&&this.logRef&&this.logRef.current&&this.logRef.current.addEventListener("scroll",this.pauseOrResumeScrolling),this.props.source){var e="string"==typeof this.props.source?(0,o.GvO)(this.props.source,this.props.data,"| raw"):this.props.source;e&&(0,o.Amo)(e)?this.loadLogs():("string"==typeof e||Array.isArray(e)&&e.every((function(e){return"string"==typeof e})))&&(this.clear(),this.addLines(Array.isArray(e)?e:[e]))}},t.prototype.componentDidUpdate=function(e){if(this.autoScroll&&this.logRef&&this.logRef.current&&(this.logRef.current.scrollTop=this.logRef.current.scrollHeight),this.props.source){var t="string"==typeof this.props.source?(0,o.GvO)(this.props.source,this.props.data,"| raw"):this.props.source;t&&(0,o.Amo)(t)?(0,o.B92)(e.source,this.props.source,e.data,this.props.data)&&this.loadLogs():("string"==typeof t||Array.isArray(t)&&t.every((function(e){return"string"==typeof e})))&&(0,o.GvO)(e.source,e.data,"| raw")!==t&&t&&(this.clear(),this.addLines(Array.isArray(t)?t:[t]))}},t.prototype.pauseOrResumeScrolling=function(){if(this.logRef&&this.logRef.current){var e=this.logRef.current,t=e.scrollHeight,r=e.scrollTop,n=e.offsetHeight;this.autoScroll=t-(r+n)<50}},t.prototype.loadLogs=function(){var e,t,r;return(0,n.sH)(this,void 0,void 0,(function(){var s,i,l,a,c,u,h,d,p,g,f,m,L,v,y,b,E,R=this;return(0,n.YH)(this,(function(n){switch(n.label){case 0:return s=this.props,i=s.source,l=s.data,a=s.env,c=s.translate,u=s.encoding,s.maxLength,h=s.credentials,d=void 0===h?"include":h,(p=(0,o.lSp)(i,l)).url?[4,fetch(p.url,{method:(null===(e=p.method)||void 0===e?void 0:e.toLocaleUpperCase())||"GET",headers:p.headers||void 0,body:p.data?JSON.stringify(p.data):void 0,credentials:d})]:[2];case 1:if(200!==(g=n.sent()).status)return[3,8];if(!(f=g.body))return[2];m=f.getReader(),n.label=2;case 2:return this.state.refresh?[3,4]:[4,m.cancel("click cancel button").then((function(){R.props.env.notify("success","日志已经停止刷新")}))];case 3:n.sent(),n.label=4;case 4:return[4,m.read()];case 5:if(L=n.sent(),v=L.done,(y=L.value)&&(b=new TextDecoder(u).decode(y,{stream:!0}),E=b.split("\n"),this.addLines(E)),v)return this.isDone=!0,[2];n.label=6;case 6:return[3,2];case 7:return[3,9];case 8:!p.silent&&a.notify("error",null!==(r=null===(t=null==p?void 0:p.messages)||void 0===t?void 0:t.failed)&&void 0!==r?r:c("fetchFailed")),n.label=9;case 9:return[2]}}))}))},t.prototype.ansiColrToHtml=function(e){if(!0===this.props.disableColor)return e;var t=e.match(/\u001b\[([^m]+)m/);if(t){var r=t[1];if(r){if(e=e.replace(/\u001b[^m]*?m/g,""),r in l)return s.createElement("span",{style:{color:l[r]}},e);if(r in a)return s.createElement("span",{style:{backgroundColor:a[r]}},e.replace(/\u001b[^m]*?m/g,""))}}return e},t.prototype.renderHighlightWord=function(e){var t=this,r=this.props.classnames,n=this.state.filterWord;if(""===n)return this.ansiColrToHtml(e);var o=e.split(n);return o.map((function(e,i){return i<o.length-1?s.createElement("span",null,t.ansiColrToHtml(e),s.createElement("span",{className:r("Log-line-highlight")},n)):e}))},t.prototype.renderLine=function(e,t,r){var n=this.props,o=n.classnames;return n.disableColor,s.createElement("div",{className:o("Log-line"),key:e},r&&s.createElement("span",{className:o("Log-line-number")},e+1," "),this.renderHighlightWord(t))},t.prototype.render=function(){var e,t=this,r=this.props,o=r.source,l=r.className,a=r.style,c=r.classnames,u=r.placeholder,h=r.height,d=r.rowHeight,p=(r.disableColor,r.translate),g=r.operation,f=this.state,m=f.refresh,L=f.showLineNumber,v=p(u);o||(v=p("Log.mustHaveSource"));var y=this.state.lastLine?this.state.logs.concat([this.state.lastLine]):this.state.logs,b=d;return e=b?s.createElement(i.wj,{height:h,itemCount:y.length,itemSize:d,renderItem:function(e){var r=e.index,o=e.style;return s.createElement("div",{className:c("Log-line"),key:r,style:(0,n.Cl)((0,n.Cl)({},o),{whiteSpace:"nowrap"})},L&&s.createElement("span",{className:c("Log-line-number")},r+1," "),t.renderHighlightWord(y[r]))}}):y.map((function(e,r){return t.renderLine(r,e,L)})),s.createElement("div",{className:c("Log",l),style:a},s.createElement("div",{className:c("Log-operation")},g&&(null==g?void 0:g.length)>0&&s.createElement(s.Fragment,null,g.includes("stop")&&s.createElement("a",{title:p("stop"),className:m?"":"is-disabled",onClick:this.refresh},s.createElement(i.In,{icon:"pause"})),g.includes("restart")&&s.createElement("a",{title:p("reload"),className:m?"is-disabled":"",onClick:this.refresh},s.createElement(i.In,{icon:"refresh"})),g.includes("showLineNumber")&&s.createElement("a",{title:p(L?"Log.notShowLineNumber":"Log.showLineNumber"),onClick:function(e){t.setState({showLineNumber:!L}),e.preventDefault()}},s.createElement(i.In,{icon:L?"invisible":"view"})),g.includes("clear")&&s.createElement("a",{onClick:this.clear,title:p("clear")},s.createElement(i.In,{icon:"remove"})),g&&g.includes("filter")&&s.createElement(i.Gd,{className:c("Log-filter-box"),placeholder:"过滤词",onChange:function(e){return t.filterWord(t.state.originLogs,t.state.lastLine,e)},value:this.state.filterWord}))),s.createElement("div",{ref:this.logRef,className:c("Log-body"),style:{height:b?"auto":h}},b||e.length?e:v))},t.defaultProps={height:500,autoScroll:!0,placeholder:"loading",encoding:"utf-8"},t}(s.Component),u=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return(0,n.C6)(t,e),(0,n.Cg)([(0,o.A49)({type:"log"})],t)}(c)}}]);